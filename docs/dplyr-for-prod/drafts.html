<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.489">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="I wont teach you how to select columns, filter rows, use cool dplyr verbs or talk about non-standard evaluation. I’m not really interested in that. Nor am I the best person to teach you that. But rather, I want to teach you how dplyr is ready to be used in production. I want to show you how you can write dplyr code that can scale. The same code can run on a few thousand rows, tens of thousands, and millions of rows all with very little change to your existing dplyr code. These lessons are to encourage you to think about your code differently. Not as R code, but as production-grade data engineering code.">

<title>flrsh-site - dplyr is production</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">flrsh-site</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#outline" id="toc-outline" class="nav-link active" data-scroll-target="#outline">Outline:</a></li>
  <li><a href="#preface" id="toc-preface" class="nav-link" data-scroll-target="#preface">Preface</a></li>
  <li><a href="#r-and-evaluation" id="toc-r-and-evaluation" class="nav-link" data-scroll-target="#r-and-evaluation">R and evaluation</a></li>
  <li><a href="#what-does-it-mean-to-be-eager" id="toc-what-does-it-mean-to-be-eager" class="nav-link" data-scroll-target="#what-does-it-mean-to-be-eager">What does it mean to be “eager?”</a></li>
  <li><a href="#being-lazy-pays-off" id="toc-being-lazy-pays-off" class="nav-link" data-scroll-target="#being-lazy-pays-off">Being lazy pays off</a></li>
  <li><a href="#create-your-own-lazy-function" id="toc-create-your-own-lazy-function" class="nav-link" data-scroll-target="#create-your-own-lazy-function">Create your own lazy function</a></li>
  <li><a href="#making-dplyr-lazy" id="toc-making-dplyr-lazy" class="nav-link" data-scroll-target="#making-dplyr-lazy">Making dplyr lazy</a></li>
  <li><a href="#understanding-the-lazy-table" id="toc-understanding-the-lazy-table" class="nav-link" data-scroll-target="#understanding-the-lazy-table">Understanding the lazy table</a></li>
  <li><a href="#the-composable-codex" id="toc-the-composable-codex" class="nav-link" data-scroll-target="#the-composable-codex">The composable codex</a></li>
  <li><a href="#composable-codex---modularity" id="toc-composable-codex---modularity" class="nav-link" data-scroll-target="#composable-codex---modularity">Composable codex - modularity</a></li>
  <li><a href="#scaling-up-from-traditional-dplyr-code" id="toc-scaling-up-from-traditional-dplyr-code" class="nav-link" data-scroll-target="#scaling-up-from-traditional-dplyr-code">Scaling up from traditional dplyr code</a></li>
  <li><a href="#dtplyr" id="toc-dtplyr" class="nav-link" data-scroll-target="#dtplyr">dtplyr</a></li>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">dplyr is production</h1>
</div>

<div>
  <div class="description">
    <p>I wont teach you how to select columns, filter rows, use cool dplyr verbs or talk about non-standard evaluation. I’m not really interested in that. Nor am I the best person to teach you that. But rather, I want to teach you how dplyr is ready to be used in production. I want to show you how you can write dplyr code that can scale. The same code can run on a few thousand rows, tens of thousands, and millions of rows all with very little change to your existing dplyr code. These lessons are to encourage you to think about your code differently. Not as R code, but as production-grade data engineering code.</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="outline" class="level2">
<h2 class="anchored" data-anchor-id="outline">Outline:</h2>
<ul>
<li>eager evaluation</li>
<li>lazy evaluation</li>
<li>lazy tables</li>
</ul>
</section>
<section id="preface" class="level2">
<h2 class="anchored" data-anchor-id="preface">Preface</h2>
<p>dplyr’s impact on data science often goes under-recognized. It is known most often for its readable syntax and chainable expression. dplyr’s undeniable ergonomics has led to impersonations and derivations across languages: from the many python implementations such as <a href="https://github.com/machow/siuba"><code>siuba</code></a>, <a href="https://pythonhosted.org/dplython/"><code>dplython</code></a>, <a href="https://github.com/maxhumber/redframes"><code>redframes</code></a>, <a href="https://github.com/kieferk/dfply"><code>dfply</code></a>, and now the great <a href="https://ibis-project.org/">Ibis</a> project—which, as you’ll see, shares more than just syntax—and I’m sure many more. One can also see the influence of dplyr’s syntax in <a href="https://docs.pola.rs/">Polars</a>, the powerful rust based dataframe library with navtive bindings to python and community provided bindings to R. The <a href="https://tidierorg.github.io/TidierData.jl/latest/"><code>TidierData.jl</code></a> library is a 100% Julia implementation that “stick[s] as closely to tidyverse syntax as possible.”</p>
<p>They say that imitation is the highest form of flattery. But in this case, I think it also speaks to the impact made by dplyr and the broader tidyverse ecosystem.</p>
</section>
<section id="r-and-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="r-and-evaluation">R and evaluation</h2>
<p>Before we dive into the nuts and bolts of how what makes dplyr so powerful in production code, we need to first have a good understanding of the two primary types of evaluation strategies in R. We need to first be able to understand the distinction between eager and lazy evaluation.</p>
</section>
<section id="what-does-it-mean-to-be-eager" class="level2">
<h2 class="anchored" data-anchor-id="what-does-it-mean-to-be-eager">What does it mean to be “eager?”</h2>
<p>dplyr, and the vast majority of code that we run in R is eagerly evaluated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>skin_colors <span class="ot">&lt;-</span> starwars <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(skin_color) <span class="sc">|&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we execute this expression, it runs right to completion no questions asked. Eager evaluation wants to get the job done right then and there. Most functions that we use in R are eagerly evaluated. You run them, wait for them to come to completion, then have the results.</p>
<p>But being quick on the draw is not always the most effective use of time. Sometimes it pays to be lazy. This is particularly true when working with large datasets. A less common approach is <em><strong>lazy evaluation</strong></em>.</p>
</section>
<section id="being-lazy-pays-off" class="level2">
<h2 class="anchored" data-anchor-id="being-lazy-pays-off">Being lazy pays off</h2>
<!-- shuold there be a way to click a word and have a popover of the definition? Like a glossary idea ? -->
<p>Lazy evaluation, or sometimes referred to as “call-by-need”, delays execution until the very last moment. In R, function arguments are lazily evaluated. That means that the value of them are not computed until they are actually needed. This is very powerful! It let’s us write code like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>lazyy <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">y =</span> x <span class="sc">+</span> <span class="dv">2</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">+</span> y</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lazyy</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<p>The value of <code>y</code> is set to the value of <code>x</code> plus <code>2</code> but we don’t actually know the value of <code>x</code> until it’s provided as an argument. For a bit clearer example, take, this function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hello_world <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"hello world"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hello_world</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hello world"</code></pre>
</div>
</div>
<p>It prints <code>"hello world"</code>, but did you notice something? We provided an argument <code>x</code>, that is never used! Since the argument <code>x</code> is never used, and arguments are lazily evaluated, it will never be executed. That means we can commit crimes in the x argument but never get caught.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hello_world</span>(<span class="fu">stop</span>(<span class="st">"You shall not pass!!"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "hello world"</code></pre>
</div>
</div>
<p>We’ve tried to abort the function by calling <code>stop()</code> in the function argument. No dice.</p>
<p>Let’s try another example where we conditionally evaluate an argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>null_or_y <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(x)) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    y</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this function we can pass a value of <code>TRUE</code> and it will return the value of <code>y</code>, if the value is <code>FALSE</code>, then function will return <code>NULL</code>.</p>
<p>When <code>x = TRUE</code>, the argument <code>y</code> is evaluated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">null_or_y</span>(<span class="cn">TRUE</span>, <span class="fu">stop</span>(<span class="st">"stop right there! 👮🏻‍♂️"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in null_or_y(TRUE, stop("stop right there! 👮🏻‍♂️")): stop right there! 👮🏻‍♂️</code></pre>
</div>
</div>
<p>However, if we provide <code>FALSE</code>…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">null_or_y</span>(<span class="cn">FALSE</span>, <span class="fu">stop</span>(<span class="st">"stop right there! 👮🏻‍♂️"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
<p>No error is emitted, and we get <code>NULL</code> returned back to us.</p>
</section>
<section id="create-your-own-lazy-function" class="level2">
<h2 class="anchored" data-anchor-id="create-your-own-lazy-function">Create your own lazy function</h2>
<p>TODO make exercise with lazy evaluation in a function</p>
</section>
<section id="making-dplyr-lazy" class="level2">
<h2 class="anchored" data-anchor-id="making-dplyr-lazy">Making dplyr lazy</h2>
<p>dplyr extends this concept of this laziness to data.frames and tables more generally. We’ll explore the concept of lazy tables through the package <a href="https://dtplyr.tidyverse.org/"><code>{dtplyr}</code></a>.</p>
<p>In the R community there has been this debate of base R versus dplyr versus data.table for years now. It is <em>very</em> divisive. It’s so divisive that I actually lost a job at DataCamp because of it. Though that’s a story to be shared over a beer.</p>
<p><a href="https://rdatatable.gitlab.io/data.table/"><code>data.table</code></a> is another data.frame oriented data manipulation package. It is indisputably, until recently with the publication of <a href="https://sebkrantz.github.io/collapse/"><code>collapse</code></a>, the fastest in memory data.frame manipulation package in the R ecosystem. However, to use data.table, one has to learn a fairly idiosyncratic “i, j, by” syntax (data.table uses super-powered version of base R’s bracket indexing). Learning a new syntax can be a deterrent which is why I think data.table is not as widely adopted as perhaps ought to be.</p>
<p>As a motivating example, let’s adapt the example from the <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html">Introduction to data.table</a> vignette.</p>
<p>Using the <a href="https://cran.r-project.org/web/packages/nycflights13/index.html"><code>nycflights13</code></a> dataset, we can count the number of American Airlines flights by origin, destinations, and arrange them. Using traditional dplyr our code might look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nycflights13)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>flights <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(carrier <span class="sc">==</span> <span class="st">"AA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(origin, dest) <span class="sc">|&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(origin, <span class="fu">desc</span>(dest))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 3
   origin dest      n
   &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
 1 EWR    MIA    1068
 2 EWR    LAX     365
 3 EWR    DFW    2054
 4 JFK    TPA     311
 5 JFK    STT     303
 6 JFK    SJU    1099
 7 JFK    SFO    1422
 8 JFK    SEA     365
 9 JFK    SAN     365
10 JFK    ORD     365
# ℹ 15 more rows</code></pre>
</div>
</div>
<p>The same code can be written fairly succinctly with data.table. However, if you don’t know the syntax very well, like I don’t, it can be quite terse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a copy so that data.table can modify by reference</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>fl <span class="ot">&lt;-</span> <span class="fu">setDT</span>(<span class="fu">copy</span>(flights))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>fl[carrier <span class="sc">==</span> <span class="st">"AA"</span>, .N, by <span class="ot">=</span> .(origin, dest)][<span class="fu">order</span>(origin, <span class="sc">-</span>dest)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    origin   dest     N
    &lt;char&gt; &lt;char&gt; &lt;int&gt;
 1:    EWR    MIA  1068
 2:    EWR    LAX   365
 3:    EWR    DFW  2054
 4:    JFK    TPA   311
 5:    JFK    STT   303
 6:    JFK    SJU  1099
 7:    JFK    SFO  1422
 8:    JFK    SEA   365
 9:    JFK    SAN   365
10:    JFK    ORD   365
11:    JFK    MIA  2221
12:    JFK    MCO   730
13:    JFK    LAX  3217
14:    JFK    LAS   639
15:    JFK    IAH   274
16:    JFK    FLL   182
17:    JFK    EGE   103
18:    JFK    DFW   367
19:    JFK    BOS  1455
20:    JFK    AUS   365
21:    LGA    STL   902
22:    LGA    PBI    82
23:    LGA    ORD  5694
24:    LGA    MIA  3945
25:    LGA    DFW  4836
    origin   dest     N</code></pre>
</div>
</div>
<p>Did it feel faster? I don’t know if you could tell the difference from this one example, but I can assure you, it <em>is</em> faster. Let’s take a look by creating a <a href="https://bench.r-lib.org/"><code>bench::mark()</code></a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>bench::mark()</code> works by providing named expressions that are each evaluated and time multiple times.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr =</span> {</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    flights <span class="sc">|&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(carrier <span class="sc">==</span> <span class="st">"AA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">count</span>(origin, dest) <span class="sc">|&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(origin, <span class="fu">desc</span>(dest))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt =</span> fl[carrier <span class="sc">==</span> <span class="st">"AA"</span>, .N, <span class="at">by =</span> .(origin, dest)][<span class="fu">order</span>(origin, <span class="sc">-</span>dest)],</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">check =</span> <span class="cn">FALSE</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 dplyr        7.21ms   7.83ms      119.   10.35MB     24.3
2 dt           1.76ms   1.91ms      513.    2.26MB     24.2</code></pre>
</div>
</div>
<p>In this bench mark, data.table is just about 4.5 times <em>faster</em> than dplyr! That’s nothing to scoff at. Maybe even more significantly, data.table used far less memory! Sure, 10mb isn’t too much now. But what about when we’re working with 10 million rows in memory? You <em>will</em> feel the difference then.</p>
<p>To get this level of performance, you don’t have to actually start writing data.table code. You can instead use <code>dtplyr</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>fl_lazy <span class="ot">&lt;-</span> <span class="fu">lazy_dt</span>(flights)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>fl_lazy <span class="sc">|&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(carrier <span class="sc">==</span> <span class="st">"AA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(origin, dest) <span class="sc">|&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(origin, <span class="fu">desc</span>(dest))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [25 x 3]
Call:   setorder(`_DT1`[carrier == "AA"][, .(n = .N), keyby = .(origin, 
    dest)], origin, -dest, na.last = TRUE)

  origin dest      n
  &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
1 EWR    MIA    1068
2 EWR    LAX     365
3 EWR    DFW    2054
4 JFK    TPA     311
5 JFK    STT     303
6 JFK    SJU    1099
# ℹ 19 more rows

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
<p>The <code>lazy_dt()</code> function is the key here. It creates a <code>dtplyr_step</code> object which allows us to make use of data.table via dplyr functions. The print method of the results are very informative. We’ll dive into this in the next section. But before then, Let’s make another bench mark to compare the results. Don’t worry about all of the code in there, we’ll go over it shortly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dtplyr =</span> {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    fl_lazy <span class="sc">|&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(carrier <span class="sc">==</span> <span class="st">"AA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">count</span>(origin, dest) <span class="sc">|&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(origin, <span class="fu">desc</span>(dest)) <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt =</span> fl[carrier <span class="sc">==</span> <span class="st">"AA"</span>, .N, <span class="at">by =</span> .(origin, dest)][<span class="fu">order</span>(origin, <span class="sc">-</span>dest)],</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">check =</span> <span class="cn">FALSE</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 dtplyr       4.24ms   4.57ms      217.    5.04MB     24.1
2 dt           1.76ms   1.88ms      530.    2.26MB     12.8</code></pre>
</div>
</div>
</section>
<section id="understanding-the-lazy-table" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-lazy-table">Understanding the lazy table</h2>
<p>In the previous section we created what is referred to as a lazy table. Let’s spend some time understanding what we did. The function <code>lazy_dt()</code> converted our tibble into a <em>lazy</em> data.table.</p>
<p>The <a href="https://dtplyr.tidyverse.org/reference/lazy_dt.html">manual page</a> for <code>lazy_dt()</code> says</p>
<blockquote class="blockquote">
<p>“A lazy data.table captures the intent of dplyr verbs, only actually performing computation when requested…”</p>
</blockquote>
<p>This is similar to the concept of lazy function argument evaluation. But instead of delaying evaluation, dtplyr is building up an expression that will eventually be evaluated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  fl_lazy <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(carrier <span class="sc">==</span> <span class="st">"AA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(origin, dest) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(origin, <span class="fu">desc</span>(dest))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [25 x 3]
Call:   setorder(`_DT1`[carrier == "AA"][, .(n = .N), keyby = .(origin, 
    dest)], origin, -dest, na.last = TRUE)

  origin dest      n
  &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
1 EWR    MIA    1068
2 EWR    LAX     365
3 EWR    DFW    2054
4 JFK    TPA     311
5 JFK    STT     303
6 JFK    SJU    1099
# ℹ 19 more rows

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
<p>Above the data preview we can see the <code>Call</code> that has been created. dtplyr is <em>translating</em> our dplyr code into data.table code. In essence, our dplyr code is acting as a <strong>front-end</strong> while data.table is acting the <strong>back-end</strong>. In this case, the front-end is the user-facing interface—in this case the user is the developer—and the backend is where the computation is occurring. We can see the translation that dtplyr has built up by using <code>dplyr::show_query()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_query</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>setorder(`_DT1`[carrier == "AA"][, .(n = .N), keyby = .(origin, 
    dest)], origin, -dest, na.last = TRUE)</code></pre>
</div>
</div>
<p>dtplyr is essentially acting is a translator between a common syntax in dplyr and an execution engine in data.table. dtplyr is being lazy in that it is not running any code but instead it is building up a set of instructions that will be executed.</p>
<p>To make dtplyr actually execute the code that it has built up, we need to request the results. This is done by using <code>dplyr::collect()</code>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that you can also use <code>as.data.table()</code>, <code>as_tibble()</code>, <code>as.data.frame()</code> to bring the results into a data.frame.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collect</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 3
   origin dest      n
   &lt;chr&gt;  &lt;chr&gt; &lt;int&gt;
 1 EWR    MIA    1068
 2 EWR    LAX     365
 3 EWR    DFW    2054
 4 JFK    TPA     311
 5 JFK    STT     303
 6 JFK    SJU    1099
 7 JFK    SFO    1422
 8 JFK    SEA     365
 9 JFK    SAN     365
10 JFK    ORD     365
# ℹ 15 more rows</code></pre>
</div>
</div>
</section>
<section id="the-composable-codex" class="level2">
<h2 class="anchored" data-anchor-id="the-composable-codex">The composable codex</h2>
<ul>
<li>composable data ecosystem</li>
<li>modularity https://ibis-project.org/concepts/composable-ecosystem.html</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nycflights13)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> dbplyr<span class="sc">::</span><span class="fu">src_memdb</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in (function (cond) : error in evaluating the argument 'drv' in selecting a method for function 'dbConnect': there is no package called 'RSQLite'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">copy_to</span>(con, nycflights13<span class="sc">::</span>flights, <span class="at">name =</span> <span class="st">"flights"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'con' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"nycflights13::flights"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'con' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nothing has happened yet...</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>avg_delay <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(carrier) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_delay =</span> <span class="fu">min</span>(dep_delay),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_delay =</span> <span class="fu">max</span>(dep_delay),</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_delay =</span> <span class="fu">mean</span>(dep_delay)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>avg_delay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>multiple objects</li>
<li>complex joins and queries by creating sub-queries</li>
<li>creating multiple objects has no cost because it’s lazy</li>
</ul>
</section>
<section id="composable-codex---modularity" class="level2">
<h2 class="anchored" data-anchor-id="composable-codex---modularity">Composable codex - modularity</h2>
</section>
<section id="scaling-up-from-traditional-dplyr-code" class="level2">
<h2 class="anchored" data-anchor-id="scaling-up-from-traditional-dplyr-code">Scaling up from traditional dplyr code</h2>
</section>
<section id="dtplyr" class="level2">
<h2 class="anchored" data-anchor-id="dtplyr">dtplyr</h2>
<ul>
<li>mutability / immutability</li>
<li>or, copy on modify https://stackoverflow.com/questions/15759117/what-exactly-is-copy-on-modify-semantics-in-r-and-where-is-the-canonical-source</li>
</ul>
</section>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<ul>
<li>conceptually, want to make it clear that writing dplyr is writing SQL</li>
<li>learn about lazy computation</li>
</ul>
<p>Outline:</p>
<ul>
<li><p>What dplyr is</p></li>
<li><p>It pays to be lazy</p>
<ul>
<li>lazy vs eager computation
<ul>
<li>dplyr is eager</li>
<li>databases are lazy</li>
</ul></li>
</ul></li>
<li><p>composable data systems</p></li>
<li><p>dplyr is a syntax that acts as a developer oriented API that is agnostic to the backend that is used</p>
<ul>
<li>it allows for a distinction between the “front-end” and the “back-end”</li>
</ul></li>
<li><p>with dplyr, you can manipulate data.frames in memory, yah sure, that’s just the beginning.</p></li>
<li><p>Other supported dplyr backends:</p>
<ul>
<li>data.table</li>
<li>duckdb</li>
<li>arrow</li>
<li>apache spark</li>
</ul></li>
</ul>
<p>“DBI separates the connectivity to the DBMS into a “front-end” and a “back-end”.” - https://dbi.r-dbi.org/ - many R packages have been built upon it to provide database connectivity to R - some of the supported database back-ends - Postgres, MariaDB, BigQuery - odbc connections and more if using Posit professional drivers</p>
<p>Motivation: - you can prototype code on simple csv files - the same dplyr code can then be used on bigger and bigger data just by changing the bac end - it also can be helpful in making it easier to avoid vendor lock in because the only vendor dependent code is going to be the connection object</p>
<p>At NPD we trained SAS users on dplyr. Much of the SAS scripts involed first getting data from our databases and pre-processing it using proc sql. They would rewrite their code using dplyr and a csv file. Then we plugged it into spark with databricks with very little effort after that.</p>
<p>My recommendation for using dplyr:</p>
<ul>
<li>start with basic dplyr for &lt; 1m rows or when spending a few seconds computing isn’t that big of a deal</li>
<li>if you need to scale it a bit then I would recommend using a lazy data.table</li>
<li>at the end of the day, we want to bring as little into R’s memory as we possibly.</li>
</ul>
<p>Restrictions:</p>
<ul>
<li>you cannot mix R functions with SQL</li>
<li>some stringr functions have dbplyr support</li>
</ul>
<p>To cover:</p>
<ul>
<li>laziness in tables</li>
<li>dplyr remote table functions</li>
<li>dbplyr
<ul>
<li>https://dbplyr.tidyverse.org/articles/sql.html#what-happens-when-dbplyr-failsx</li>
</ul></li>
<li>creating DBI connections</li>
<li><code>{pool}</code> for managing multiple connections https://rstudio.github.io/pool/</li>
</ul>
<p>Scheduling? Rscript, bash, cron</p>
<p>when using dbplyr try to work with tables don’t use %in% with sql its slow. Instead use a filtering join like semi join</p>
<hr>
<p>https://www.youtube.com/watch?v=QC7WktPt7ow</p>
<p>“[dbplyr] takes R from just a simple tool to an incredibly powerful analysis platform”</p>
<p>dbplyr is for RDBMS relational database management systems</p>
<p>dplyr is the inspiration for ibis in the python ecosystem https://www.youtube.com/watch?v=XRxUeL3bQfQ&amp;t=955s</p>
<p>arrow database connector https://cloud.r-project.org/web/packages/adbi/index.html</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>